<%- include('includes/header') %>

<title>Heimursaga | Settings</title>

</head>

<%- include('includes/sidebar') %>

<%- include('includes/navbar') %>

			<main class="content">
				<div class="container-fluid p-0">
						
						<div class="row">

						<div class="col-md-3 col-xl-2">

							<div class="card">
								<div class="card-header">
									<h5 class="card-title mb-0">Profile Settings</h5>
								</div>

								<div class="list-group list-group-flush" role="tablist">
									<a class="list-group-item list-group-item-action active" data-bs-toggle="list" href="#account" role="tab">
          							Public Info
        							</a>
									<a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#notifications" role="tab">
          							Notifications
        							</a>
									<a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#password" role="tab">
									Password
		  							</a>
									<a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#billing" role="tab">
										Billing Detail
        							</a>

									<% if(plan && plan !== 'none' && !stripeAccountId){ %> 

									<a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#connect-bank" role="tab">
										Connect Bank
									</a>
									<% } %>
									<!-- <a class="list-group-item list-group-item-action disabled" data-bs-toggle="list" href="#" role="tab">
          							Delete account
									</a> -->
								</div>
							</div>
						</div>

						

						<div class="col-md-9 col-xl-10">
							<%- include('includes/flash') %>
							<div class="tab-content">
								<div class="tab-pane fade show active" id="account" role="tabpanel">
									
									
												<form action="/update-user/<%= user.username %>" method="POST">
													<div class="card">
														<div class="card-header">
															<h5 class="card-title mb-0">Public Info Settings</h5>
														</div>
														<div class="card-body col-md-10 offset-md-1">

															<div class="mb-5">
																<label class="form-label text-dark">Explorer Avatar</label>
																<div class="">
																<img src="<%= user.avatar %>" class="img-fluid rounded-circle mb-2" width="128" height="128" />
																</div>
																<label class="form-text text-muted">Heimursaga uses the Gravatar service for profile avatars. Your avatar is linked to the email you used to register your Heimursaga account. Please visit <a href="https://en.gravatar.com" target="_blank">gravatar.com</a> to update or set your explorer avatar.</label>
															</div>
															<div class="mb-3">
																<input type="text" class="form-control" id="username-register" name="username" maxlength="30" value="<%= user.username %>"hidden>
															</div>
															<div class="mb-3">
																<input type="email" class="form-control" id="email-register" name="email" value="<%= email %>" hidden>
															</div>
															<div class="mb-3">
																<label class="form-label text-dark">Bio</label>
																<label class="form-text text-muted">- a little bit about you (200 char.)</label>
																<textarea rows="3" class="form-control" id="bio" name="bio" maxlength="200"><%= bio %></textarea>
															</div>
															<div class="mb-3">
																<label class="form-label text-dark">Currently In</label>
																<label class="form-text text-muted">- where are you currently? (50 char.)</label>
																<input class="form-control" id="currentlyin" name="currentlyin" maxlength="50" value="<%= currentlyin %>">
															</div>
															<div class="mb-3">
																<label class="form-label text-dark">Lives In</label>
																<label class="form-text text-muted">- where do you call home? (50 char.)</label>
																<input class="form-control" id="livesin" name="livesin" value="<%= livesin %>" maxlength="50">
															</div>
															<div class="mb-5">
																<label class="form-label text-dark">From</label>
																<label class="form-text text-muted">- where are you from? (50 char.)</label>
																<input class="form-control" id="from" name="from" value="<%= from %>" maxlength="50">
															</div>
															<!--<div class="mb-3">
																<label class="form-label">Instagram</label>
																<label class="form-text text-muted">- if you want to link your instagram on your profile</label>
																<input class="form-control" id="instagram" name="instagram" placeholder="<%= user.instagram %>" maxlength="50">
															</div>
															<div class="mb-3">
																<label class="form-label">Website</label>
																<label class="form-text text-muted">- if you want to link a blog or personal website</label>
																<input class="form-control" id="website" name="website" placeholder="<%= user.website %>" maxlength="50">
															</div>-->

															<div>

																<input type="hidden" name="_csrf" value="<%= csrfToken %>">
		
																<button type="submit" class="btn btn-primary">Save changes</button>
		
															</div>

														</div>
													</div>
												</form>


								</div>

								<div class="tab-pane fade" id="password" role="tabpanel">
									<form action="/update-password/<%= user.username %>" method="POST">
										<div class="card">
											<div class="card-header">
												<h5 class="card-title mb-0">Password Settings</h5>
											</div>

											<div class="card-body col-md-10 offset-md-1">

													<div class="mb-3">
														<input type="text" class="form-control" id="username-register" name="username" maxlength="30" value="<%= user.username %>"hidden>
													</div>

													<div class="mb-3">
														<input type="email" class="form-control" id="email-register" name="email" value="<%= email %>" hidden>
													</div>
			
													<!--<div class="mb-5">
														<label for="inputPasswordCurrent" class="form-label">Current password</label>
														<input type="password" name="CurrentPassword" class="form-control form-control-lg" id="CurrentPassword">
														<small><a href="#">Forgot your password?</a></small>
													</div>-->

													<div class="mb-3">

														<style>
															.form-item {
																position: relative;
																}
		
															.fas-eye {
																position: absolute;
																right: 1.1rem;
																top: 0.8rem;
																cursor: pointer;
																}
														</style>
														<label class="form-label">New Password</label>
														<div class="form-item">
															<input type="password" name="PasswordNew" class="form-control form-control-lg" id="PasswordNew" maxlength="50" minlength="8"/>
															<i class="fas-eye fas fa-eye" id="eye"></i>
														  </div>
		
													</div>
													<div class="mb-5">
														<label class="form-label">Confirm Password</label>
															<input class="form-control form-control-lg" type="password" name="confirm_password" id="confirm_password"/>
															<span id='message'></span>
													</div>

													<div>

														<input type="hidden" name="_csrf" value="<%= csrfToken %>">

														<button id="pass-submit" type="submit" class="btn btn-primary">Save changes</button>

													</div>

											</div>
										</div>
									</form>	
								</div>

								<div class="tab-pane fade" id="notifications" role="tabpanel">
									<form action="/update-notifications/<%= user.username %>" method="POST">
										<div class="card">
											<div class="card-header">
												<h5 class="card-title mb-0">Notification Settings</h5>
											</div>

											<div class="card-body col-md-10 offset-md-1">

													<div class="mb-3">
														<input type="text" class="form-control" id="username-register" name="username" maxlength="30" value="<%= user.username %>"hidden>
													</div>

													<div class="mb-3">
														<input type="email" class="form-control" id="email-register" name="email" value="<%= email %>" hidden>
													</div>

													<label class="form-label text-dark mb-3">Email Notifications</label>

													<div class="mb-3">
														<div class="form-check form-switch">
															<input class="form-check-input" type="checkbox" value="true" name="followersemailnotifications" id="followersemailnotifications"<% if (settings.emailNotifications.followers == "true") { %> checked <% } %>/>
															<label class="form-check-label">email notifications for new followers</label>
														</div>
													</div>
													<div class="mb-5">
														<div class="form-check form-switch">
															<input class="form-check-input" type="checkbox" value="true" name="likesemailnotifications" id="likesemailnotifications" <% if (settings.emailNotifications.likes == "true") { %> checked <% } %>/>
															<label class="form-check-label">email notifications for new entry highlights</label>
														</div>
													</div>

													<!--<label class="form-label text-dark mb-3">Push Notifications</label><small> (must have push notifications enabled)</small>

													<div class="mb-3">
														<div class="form-check form-switch">
															<input class="form-check-input" type="checkbox" value="true" name="followerspushnotifications" id="followerspushnotifications"<% if (settings.pushNotifications.followers == "true") { %> checked <% } %>/>
															<label class="form-check-label">push notifications for new followers</label>
														</div>
													</div>
													<div class="mb-5">
														<div class="form-check form-switch">
															<input class="form-check-input" type="checkbox" value="true" name="likespushnotifications" id="likespushnotifications" <% if (settings.pushNotifications.likes == "true") { %> checked <% } %>/>
															<label class="form-check-label">push notifications for new entry highlights</label>
														</div>
													</div>-->

													<div>

														<input type="hidden" name="_csrf" value="<%= csrfToken %>">

														<button type="submit" class="btn btn-primary">Save changes</button>

													</div>

											</div>
										</div>

									</form>	
								</div>

								<div class="tab-pane fade" id="billing" role="tabpanel">
									<div class="card p-4">
										<div>
											<% if (plan === 'yearly_exp' ) { %>
												<div>You have subscribed to
													<span style="color: green; font-weight: bold;">Annual Explorer Pro</span>
													Plan
												</div>
												<% } else if(plan === 'monthly_exp' ) { %>
													<div>You have subscribed to
														<span style="color: green; font-weight: bold;"> Monthly Explorer Pro <% plan %> </span>
														Plan
													</div>

													<% } else if(plan === 'none' || !plan){ %>

														<div>You have subscribed to
															<span style="color: green; font-weight: bold;"> Basic </span>
															Plan. Go to <a href="/upgrade/<%= user.username %>">upgrade</a> page to upgrade your plan!
														</div>
														<% }  %>
														<div>
															<% if(hasTrial){ %>
								
																<div class="lead">Trial active until date 
																	<span class="text-success">
																		<%= endDate  %>
																	</span>
																	</div>
								
																<div class="manageBilling mb-2">
																	<button id="manage_billing" class="btn btn-primary">Manage Subscription</button>
																</div>
																<% }  %>
														</div>
										</div>
								
									</div>
								</div>
								
								<div class="tab-pane fade" id="connect-bank" role="tabpanel">
									<div class="card p-4">
								
										<% if(plan && plan!=='none' && !stripeAccountId){ %>
											<p class="text-sm">Connect bank so that users can send you funds.</p>
											<div class="d-flex flex-row gap-2">
												<div class="d-flex flex-column">
													<select id="select_country">
														<option value="">Select Country....</option>
														<option value="AU">Australia</option>
														<option value="AT">Austria</option>
														<option value="BE">Belgium</option>
														<option value="BR">Brazil</option>
														<option value="BG">Bulgaria</option>
														<option value="CA">Canada</option>
														<option value="CY">Cyprus</option>
														<option value="CZ">Czech Republic</option>
														<option value="DK">Denmark</option>
														<option value="EE">Estonia</option>
														<option value="FI">Finland</option>
														<option value="FR">France</option>
														<option value="DE">Germany</option>
														<option value="GI">Gibraltar</option>
														<option value="GR">Greece</option>
														<option value="HK">Hong Kong</option>
														<option value="HU">Hungary</option>
														<option value="ID">Indonesia</option>
														<option value="IE">Ireland</option>
														<option value="IT">Italy</option>
														<option value="JP">Japan</option>
														<option value="LV">Latvia</option>
														<option value="LI">Liechtenstein</option>
														<option value="LT">Lithuania</option>
														<option value="LU">Luxembourg</option>
														<option value="MY">Malaysia</option>
														<option value="MT">Malta</option>
														<option value="MX">Mexico</option>
														<option value="NL">Netherlands</option>
														<option value="NZ">New Zealand</option>
														<option value="NO">Norway</option>
														<option value="PL">Poland</option>
														<option value="PT">Portugal</option>
														<option value="RO">Romania</option>
														<option value="SG">Singapore</option>
														<option value="SK">Slovakia</option>
														<option value="SI">Slovenia</option>
														<option value="ES">Spain</option>
														<option value="SE">Sweden</option>
														<option value="CH">Switzerland</option>
														<option value="TH">Thailand</option>
														<option value="AE">United Arab Emirates</option>
														<option value="GB">United Kingdom</option>
														<option value="US">United States</option>
													</select>
													<div id="error-box" style="color: red;"></div>
												</div>
												<div class="connect-bank">
													<button id="connect-bank" class="btn btn-primary">Connect Bank</button>
												</div>
											</div>
											<% } %>
									</div>
								</div>
								
								</div>
								</div>
							</div>

						</div>

					</div>

				</div>
			</main>

<%- include('includes/footer') %>

<script>
		const password = document.querySelector("#PasswordNew");
		const confirmpassword = document.querySelector("#confirm_password");
		const eyeIcon = document.querySelector("#eye");
		const submit = document.querySelector("#pass-submit")

		eyeIcon.addEventListener("click", () => {
		if (eyeIcon.classList.contains("fa-eye")) {
			password.setAttribute("type", "text");
			confirmpassword.setAttribute("type", "text")
			eyeIcon.classList.replace("fa-eye", "fa-eye-slash");
		} else {
			password.setAttribute("type", "password");
			confirmpassword.setAttribute("type", "password")
			eyeIcon.classList.replace("fa-eye-slash", "fa-eye");
		}
		});

		$('#PasswordNew, #confirm_password').on('keyup', function () {
		if ($('#PasswordNew').val() == $('#confirm_password').val()) {
			submit.removeAttribute("disabled");
		} else 
			submit.setAttribute("disabled", true);
		});

		$('#PasswordNew, #confirm_password').on('keyup', function () {
		if ($('#PasswordNew').val() == $('#confirm_password').val()) {
			$('#message').html('Matching').css('color', 'green');
		} else 
			$('#message').html('Not Matching').css('color', 'red');
		});


</script>

<script type="text/javascript" src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const publishableKey = `<%- stripePubKey %>`;
        const stripe = Stripe(publishableKey);

        // selected subscription
        const monthlyBtn = document.getElementById("monthlyBtn");
        const yearlyBtn = document.getElementById("yearlyBtn");
        let monthlySubsActive = true;
        if (yearlyBtn)
            yearlyBtn.addEventListener('click', () => {
                monthlySubsActive = false;
            })

        if (monthlyBtn)
            monthlyBtn.addEventListener('click', () => {
                monthlySubsActive = true
            })

        let explorerSubs = document.getElementById('explorer');

        let manageSubscription = document.getElementById('manage_billing');

        let connectBank = document.getElementById('connect-bank')

        //select your country for connecting bank
        let dropdownList = document.getElementById('select_country');
        let selectedCountry;
        if (dropdownList)
            dropdownList.onchange = (ev) => {
                selectedCountry = dropdownList.value
                let errorBox = document.getElementById('error-box').innerHTML = ''
            }

        let plan = `<%- plan %>`;
        let email = `<%- email %>`;
        let customer = `<%- billingId %>`;
        let username = `<%- username %>`
        let country = selectedCountry;

        //monthly + annually
        if (explorerSubs) {
            explorerSubs.addEventListener('click', function () {
                if (monthlySubsActive) {
                    fetch(`/subscribe/monthly_exp`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    })
                        .then(async (result) => {
                            const response = await result.json();
                            return response
                        })
                        .then((response) => {
                            if (response?.sessionId)
                                stripe.redirectToCheckout({ sessionId: response.sessionId })
                        })
                }
                else {
                    fetch(`/subscribe/yearly_exp`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    })
                        .then(async (result) => {
                            const response = await result.json();
                            return response
                        })
                        .then((response) => {
                            if (response?.sessionId)
                                stripe.redirectToCheckout({ sessionId: response.sessionId })
                        })

                }

            })
        }

        //manage Subscription link
        if (manageSubscription) {
            manageSubscription.addEventListener('click', function () {

                const requestOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                }

                fetch(`/billing/${email}/${customer}`, requestOptions)
                    .then(async (response) => await response.json())
                    .then((result) => window.location.replace(result.url))
                    .catch((error) => console.log('error', error))

            })
        }

        // connect bank
        if (connectBank) {
            connectBank.addEventListener('click', function () {
                if (selectedCountry) {
                    const requestOptions = {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }

                    fetch(`connect_bank?email=${email}&country=${selectedCountry}&username=${username}`, requestOptions)
                        .then(async (response) => await response.json())
                        .then((result) => window.location.replace(result.url))
                        .catch((error) => console.log('error', error))
                } else {
                    let errorBox = document.getElementById('error-box').innerHTML = 'Please select a country from the dropdown list.'
                }

            })
        }
   
    });

</script>