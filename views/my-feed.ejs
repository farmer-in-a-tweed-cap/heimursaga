<%- include('includes/header') %>

<title>Heimursaga | My Feed</title>

<meta name="description" content="Heimursaga (HEY-mer-saga) is a text-focused, map-centric social media platform for explorers and travelers. Heimursaga enables users
to read and write journal entries tagged to precise geographic coordinates.">

</head>

<%- include('includes/sidebar') %>

<%- include('includes/navbar') %>


<main class="content">
        <div class="container-fluid p-0">
            <div class="row">
                <h3 class="text-center d-lg-none pb-3">My Feed</h3>

                <%- include('includes/flash') %>

                <div class="col-12 col-lg-4 d-flex">
                    <div class="card flex-fill w-100" style="height: 80vh;">

                     <!--   <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs pull-right" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#tab-1">Entries</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab-2">Explorers</a>
                                </li>

                            </ul>
                        </div> -->

                        <% if (entries.length) { %>

                        <div class="card-body overflow-auto">
                            <div class="tab-content">
                            <div class="tab-pane fade show active" id="tab-1" role="tabpanel">
                            <div class="list-group list-group-flush">

                                <% entries.forEach(function(entry) { %>
									<a data-bs-toggle="modal" href="#sizedModalMd-<%= entry._id %>" class="list-group-item list-group-item-action">
                                    <strong><%= entry.title %></strong><br/>
                                    <i class="align-middle me-0 fas fa-fw fa-map-marker-alt text-primary"></i> <small class="align-middle"><%= entry.place %> | <%= entry.date %></small><br/>
                                    <small>by <strong><%= entry.author.username %></strong></small>
                                    </a>
                                        <div class="modal fade" id="sizedModalMd-<%= entry._id %>" tabindex="-1" role="dialog" aria-hidden="true">
                                            <div class="modal-dialog modal-md modal-dialog-centered" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-body mb-0">
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body mt-0 pb-0">
                                                        <h4 class="text-center"><%= entry.title %></h4>
                                                    </div>

                                                    <div class="col-8 offset-2 mb-4">
                                                        <hr>
                                                    </div>
                          
                                                    <div class="modal-body col-md-8 offset-md-2 pb-0 pt-0 text-center">
                                                      <h5><i class="align-middle mr-5 fas fa-fw fa-map-marker-alt text-primary"></i><%= entry.place %></h5>
                                                    </div>
                                          
                                                    <div class="modal-body col-md-8 offset-md-2 pt-0 ">
                                                        <h5 class="text-center text-muted">on <%= new Date(entry.date).toLocaleString('default', { month: 'long' }) %> <%= new Date(entry.date).getDate() %>, <%= new Date(entry.date).getFullYear() %> | by <a href="/journal/<%= entry.author.username %>"><%= entry.author.username %></a></h5>
                                                    </div>
                          
                                                    <div class="modal-body">
                                                      <div class="text-center mb-1 overflow-hidden">
                                                        <img src="https://api.mapbox.com/styles/v1/mapbox/light-v10/static/pin-s+ac6d46(<%=entry.GeoJSONcoordinates.coordinates%>)/<%=entry.GeoJSONcoordinates.coordinates%>,6/300x300?access_token=pk.eyJ1IjoiY25oMTE4NyIsImEiOiJja28wZTZpNGowY3RoMnBvaTgxZ2M5c3ljIn0.t3_T3EN00e5w7D0et4hf-w">
                                                        <!--<img src="https://api.mapbox.com/styles/v1/cnh1187/ckppoum2i01vk17mzb71uh331/static/pin-s+ac6d46(<%=entry.GeoJSONcoordinates.coordinates%>)/<%=entry.GeoJSONcoordinates.coordinates%>,6/300x300?access_token=pk.eyJ1IjoiY25oMTE4NyIsImEiOiJja28wZTZpNGowY3RoMnBvaTgxZ2M5c3ljIn0.t3_T3EN00e5w7D0et4hf-w">-->
                                                      </div>
                                                      <div class="mb-4 text-center">
                                                        <small>Longitude: <%= entry.GeoJSONcoordinates.coordinates[0]%>, Latitude: <%= entry.GeoJSONcoordinates.coordinates[1]%></small>
                                                      </div>
                          
                          
                                                      <div class="modal-body mb-2">
                                                        <%- filterUserHTML(entry.body) %>
                                                      </div>

                                                      <% if (entry.hasPhoto) { %>

                                                      <div class="modal-body">
                                                        <img src="https://f002.backblazeb2.com/file/heimursaga-entry-photos/<%= entry._id %>" class="img-fluid mb-3" alt="entry image">
                                                      </div>

                                                      <% } %>
                                                      
                                                    </div>

                                                    <% if (user) { %>

                                                        <div class="iframe-container">

                                                            <iframe class="button-stack-iframe" src="button-stack/<%= entry._id %>" id="button-stack-iframe" width="100%"></iframe>
                                
                                                        </div>

                                                    <% } %>
                          
                          
                                                    <div class="col-8 offset-2 mb-4">
                                                      <hr>
                                                    </div>
                          
                                                    <div>
                                                      <p class="text-muted small mb-4 text-center">
                                                        <a href="/journal/<%= entry.author.username %>"><img class="avatar img-fluid rounded-circle me-1" src="<%= entry.author.avatar %>"></a>
                                                        Posted on <%= entry.createdDate.getMonth() + 1 %>/<%= entry.createdDate.getDate() %>/<%= entry.createdDate.getFullYear() %></p>
                                                    </div> 
                                                    
                                                    <div class="text-center mb-4">
                                                        <small class="text-muted">
                                                        <a href="/entry/<%= entry._id %>">Visit entry permalink</a>
                                                        </small>
                                                    </div>

                                                    <div class="">
													  
                                                        <iframe src="flag-button/<%= entry._id %>" id="flag-button" height="60"></iframe>
                        
                                                    </div>

                                                    <div class="modal-body m-0">
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>

                                <% }) %>

                            </div>
                            </div>

                            </div>

                        </div>

                        <% } else { %>

                        <div class="card-body">
                            <div class="text-center">
                                <h4>Hello <strong><%= user.username %></strong>, your feed is empty.</h4>
                                <p class="text-muted">Your feed displays the latest entries from the explorers you follow. Try browsing the Discovery page to find explorers you're interested in, then click the follow button on their journal page.</p>
                              </div>  
                        </div>
                        <% } %>
                        
                    </div>
                </div>

                <div class="col-12 col-lg-8 d-flex">
                    <div class="card w-100" style="height: 80vh;">
                        <div class="card d-flex w-100"">
                                <style>
                                    .mapboxgl-popup {
                                    max-width: 350px;
                                    font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
                                    }
                                </style>
                                    
                                <div id="map" class="map" style='width: 100%; height: 80vh;'></div>
                                <div id="start-geocoder" class="start-geocoder" style="display: none;"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

</main>


<script type="text/javascript">



    function convertToPlain(html){
        var tempDivElement = document.createElement("entrymarkers");
        tempDivElement.innerHTML = html;
        return tempDivElement.textContent || tempDivElement.innerText || "";
    }

    var htmlString= "<entrymarkers><%=entrymarker%></entrymarkers>";

    var markers = convertToPlain(htmlString)

</script>
			
<%- include('includes/footer') %>