<%- include('includes/header') %>

<title>Heimursaga | Upgrade</title>

</head>

<%- include('includes/sidebar') %>

<%- include('includes/navbar') %>


<main class="content">
    <div class="container-fluid p-0">

        <!--<h1 class="h3 mb-3">Plans & Pricing</h1>-->

        <%  if ( plan && plan !=='none' ) { %>

                <div>
                    <% if (plan==='yearly_exp' ) { %>
                        <div>You have subscribed to
                            <span style="color: green; font-weight: bold;">Annual Explorer Pro</span>
                            Plan
                        </div>
                    <% } else if(plan==='monthly_exp' ) { %>
                        <div>You have subscribed to
                            <span style="color: green; font-weight: bold;"> Monthly Explorer Pro</span>
                            Plan
                        </div>
                    <% } %>

                        <div>

                    <% if(hasTrial){ %>

                        <div class="lead">Trial active until <%- endDate %></div>

                        <div class="manageBilling mb-2">
                            <button id="manage_billing"  class="btn btn-primary">Manage Subscription</button>
                        </div>
                        <% } if(plan==='yearly_exp' && !stripeAccountId){ %>
                            <p class="text-sm mt-4">Connect bank so that users can send you funds.</p>
                            <div class="d-flex flex-row gap-2">
                                <div class="d-flex flex-column">
                                    <select id="select_country">
                                        <option value="">Select Country....</option>
                                        <option value="AU">Australia</option>
                                        <option value="AT">Austria</option>
                                        <option value="BE">Belgium</option>
                                        <option value="BR">Brazil</option>
                                        <option value="BG">Bulgaria</option>
                                        <option value="CA">Canada</option>
                                        <option value="CY">Cyprus</option>
                                        <option value="CZ">Czech Republic</option>
                                        <option value="DK">Denmark</option>
                                        <option value="EE">Estonia</option>
                                        <option value="FI">Finland</option>
                                        <option value="FR">France</option>
                                        <option value="DE">Germany</option>
                                        <option value="GI">Gibraltar</option>
                                        <option value="GR">Greece</option>
                                        <option value="HK">Hong Kong</option>
                                        <option value="HU">Hungary</option>
                                        <option value="ID">Indonesia</option>
                                        <option value="IE">Ireland</option>
                                        <option value="IT">Italy</option>
                                        <option value="JP">Japan</option>
                                        <option value="LV">Latvia</option>
                                        <option value="LI">Liechtenstein</option>
                                        <option value="LT">Lithuania</option>
                                        <option value="LU">Luxembourg</option>
                                        <option value="MY">Malaysia</option>
                                        <option value="MT">Malta</option>
                                        <option value="MX">Mexico</option>
                                        <option value="NL">Netherlands</option>
                                        <option value="NZ">New Zealand</option>
                                        <option value="NO">Norway</option>
                                        <option value="PL">Poland</option>
                                        <option value="PT">Portugal</option>
                                        <option value="RO">Romania</option>
                                        <option value="SG">Singapore</option>
                                        <option value="SK">Slovakia</option>
                                        <option value="SI">Slovenia</option>
                                        <option value="ES">Spain</option>
                                        <option value="SE">Sweden</option>
                                        <option value="CH">Switzerland</option>
                                        <option value="TH">Thailand</option>
                                        <option value="AE">United Arab Emirates</option>
                                        <option value="GB">United Kingdom</option>
                                        <option value="US">United States</option>
                                    </select>
                                    <div id="error-box" style="color: red;"></div>
                                </div>
                                <div class="connect-bank">
                                    <button id="connect-bank" class="btn btn-primary">Connect Bank</button>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
            
    
            <% } else { %>

                    <div class="row">
                        <div class="col-md-10 col-xl-8 mx-auto">
                            <h1 class="text-center">Explorer Account Subscriptions</h1>
                            <p class="lead text-center ">Upgrade and get a 14-day free trial, no credit card
                                required.</p>

                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="monthly">
                                    <div class="row py-4 justify-content-center">
                                        <div class="col-sm-4 mb-3 mb-md-0">
                                            <div class="card text-center h-100">
                                                <div class="card-body d-flex flex-column">
                                                    <div class="mb-4" style="height: 110px;">
                                                        <h3 class="mb-4 text-primary">EXPLORER</h3><br>
                                                        <h6 class="text-primary ">Basic</h6>
                                                        <span style="font-size: xx-large;">Free</span>
                                                    </div>
                                                    <ul class="list-unstyled mt-4">
                                                        <li class="mb-2">
                                                            Post journal entries
                                                        </li>
                                                        <li class="mb-2">
                                                            Like journal entries
                                                        </li>
                                                        <li class="mb-2">
                                                            Follow explorers
                                                        </li>
                                                    </ul>
                                                    <div class="mt-auto">
                                                        <a href="#"
                                                            class="btn btn-lg btn-outline-primary disabled">Selected</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-4 mb-3 mb-md-0 ">
                                            <div class="card text-center h-100 d-flex flex-row">
                                                <div class="card-body d-flex flex-column">
                                                    <div class="mb-4" style="height: 110px;">
                                                        <h3 class="text-primary">EXPLORER PRO</h3>
                                                        <div class="d-flex flex-row gap-2  justify-content-center">
                                                            <button id="monthlyBtn" class="btn btn-lg btn-outline-primary btn-sm active">monthly</button>
                                                            <button id="yearlyBtn" class="btn btn-lg btn-outline-primary btn-sm">yearly</button>
                                                        </div>
                                                        <div class="m-2">
                                                            <div id="monthly-detail">
                                                                <h6 class="text-primary ">monthly subscription</h6>
                                                                <span class="display-4">$7</span>
                                                                <span>/mo</span>
                                                            </div>
                                                            <div id="yearly-detail" style="display: none;">
                                                                <h6 class="text-primary">yearly subscription</h6>
                                                                <span class="display-4">$75</span>
                                                                <span>/yr</span>
                                                            </div>
                                                            </div>
                                                            </div>
                                                    <ul class="list-unstyled mt-4">
                                                        <li class="mb-2">
                                                            Post journal entries
                                                        </li>
                                                        <li class="mb-2">
                                                            Like journal entries
                                                        </li>
                                                        <li class="mb-2">
                                                            Follow explorers
                                                        </li>
                                                        <li class="mb-2">
                                                            Journal metrics
                                                        </li>
                                                        <li class="mb-2">
                                                            Journey Mode
                                                        </li>
                                                        <li class="mb-2">
                                                            Private messaging
                                                        </li>
                                                        <li class="mb-2">
                                                            Personal website and instagram links
                                                        </li>
                                                        <li class="mb-2">
                                                            Explorers Fund
                                                        </li>
                                                    </ul>
                                                    <div class="mt-auto">

                                                            <button class="btn btn-lg btn-primary" id="explorer">
                                                                <span id="button-spinner2" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" hidden></span>
                                                                Select
                                                            </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                               
                            </div>
                        </div>
                       </div>

                    <hr />

                    <div class="text-center my-4">
                        <h2>Frequently asked questions</h2>
                    </div>
                    <div class="row">
                        <div class="card-columns">
                            <div>
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="h6 card-title">Do I need a credit card to sign up?</h5>
                                        <p class="mb-0">Yes, you will be asked to input your billing information, but you will not be charged until the end of your free trial period.</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="h6 card-title">Do you offer a free trial?</h5>
                                        <p class="mb-0">Yes! All account upgrades offer a 14-day free trial. You will not be charged during this period and you
                                            may cancel at any time without penalty.</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="h6 card-title">What if I decide to cancel my
                                            subscription?</h5>
                                        <p class="mb-0">Your subscription can be cancelled at any time
                                            without penalty.</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="h6 card-title">What is Journey Mode?</h5>
                                        <p class="mb-0">Journey Mode enables chronological grouping of
                                            journal entries. Your followers will be able to visit your
                                            Journal, select a particular "Journey" and see only entries for
                                            that journey with a "journey path" line drawn between them. Additionally, journey mode allows waypoint creation.</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="h6 card-title">How does Private Messaging work?</h5>
                                        <p class="mb-0">Accounts with an Explorer Pro subscription will be
                                            able to send private messages to other Explorer Pro accounts
                                            within the web app.</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="h6 card-title">What is Explorer Sponsorship?</h5>
                                        <p class="mb-0">Explorer Sponsorship is Heimursaga'sfundraising feature. A subscription to Explorer Pro adds a
                                            "Sponsor" button to your Journal page and every entry you post. This button will enable your followers to
                                            donate or sponsor you in support of your explorations!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

    <% } %>

    </div>
</main>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const monthlyBtn = document.getElementById("monthlyBtn");
        const yearlyBtn = document.getElementById("yearlyBtn");
        const monthlyContent = document.getElementById("monthly-detail");
        const yearlyContent = document.getElementById("yearly-detail");
        if (yearlyContent)
            yearlyContent.style.display = "none";

        if (monthlyBtn)
            monthlyBtn.addEventListener("click", function () {
                monthlyContent.style.display = "block";
                yearlyContent.style.display = "none";
                monthlyBtn.classList.add("active");
                yearlyBtn.classList.remove("active");
            });

        if (yearlyBtn)
            yearlyBtn.addEventListener("click", function () {
                monthlyContent.style.display = "none";
                yearlyContent.style.display = "block";
                monthlyBtn.classList.remove("active");
                yearlyBtn.classList.add("active");
            });
    });

</script>

<script type="text/javascript" src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const publishableKey = `<%- stripePubKey %>`;
        const stripe = Stripe(publishableKey);

        // selected subscription
        const monthlyBtn = document.getElementById("monthlyBtn");
        const yearlyBtn = document.getElementById("yearlyBtn");
        let monthlySubsActive = true;
        if (yearlyBtn)
            yearlyBtn.addEventListener('click', () => {
                monthlySubsActive = false;
            })

        if (monthlyBtn)
            monthlyBtn.addEventListener('click', () => {
                monthlySubsActive = true
            })

        let explorerSubs = document.getElementById('explorer');

        let manageSubscription = document.getElementById('manage_billing');

        let connectBank = document.getElementById('connect-bank')

        //select your country for connecting bank
        let dropdownList = document.getElementById('select_country');
        let selectedCountry;
        if (dropdownList)
            dropdownList.onchange = (ev) => {
                selectedCountry = dropdownList.value
                let errorBox = document.getElementById('error-box').innerHTML = ''
            }

        let plan = `<%- plan %>`;
        let email = `<%- email %>`;
        let customer = `<%- billingId %>`;
        let username = `<%- username %>`
        let country = selectedCountry;
        let buttonSpinner = document.getElementById("button-spinner2")


        //monthly + annually
        if (explorerSubs) {
            explorerSubs.addEventListener('click', function () {
                if (monthlySubsActive) {
                    buttonSpinner.removeAttribute("hidden", true)
                    fetch(`/subscribe/monthly_exp`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    })
                        .then(async (result) => {
                            const response = await result.json();
                            return response
                        })
                        .then((response) => {
                            if (response?.sessionId)
                                stripe.redirectToCheckout({ sessionId: response.sessionId })
                        })
                }
                else {
                    buttonSpinner.removeAttribute("hidden", true)
                    fetch(`/subscribe/yearly_exp`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    })
                        .then(async (result) => {
                            const response = await result.json();
                            return response
                        })
                        .then((response) => {
                            if (response?.sessionId)
                                stripe.redirectToCheckout({ sessionId: response.sessionId })
                        })

                }

            })
        }

        //manage Subscription link
        if (manageSubscription) {
            manageSubscription.addEventListener('click', function () {

                const requestOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                }

                fetch(`/billing/${email}/${customer}`, requestOptions)
                    .then(async (response) => await response.json())
                    .then((result) => window.location.replace(result.url))
                    .catch((error) => console.log('error', error))

            })
        }

        // connect bank
        if (connectBank) {
            connectBank.addEventListener('click', function () {
                if (selectedCountry) {
                    const requestOptions = {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }

                    fetch(`connect_bank?email=${email}&country=${selectedCountry}&username=${username}`, requestOptions)
                        .then(async (response) => await response.json())
                        .then((result) => window.location.replace(result.url))
                        .catch((error) => console.log('error', error))
                } else {
                    let errorBox = document.getElementById('error-box').innerHTML = 'Please select a country from the dropdown list.'
                }

            })
        }
   
    });

</script>

<%- include('includes/footer') %>