<%- include('includes/header') %>

<title>Heimursaga | <%= entry.title %></title>

</head>

<%- include('includes/sidebar') %>

<%- include('includes/navbar') %>

<main class="content">
    <div class="container-fluid p-0">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card">
                    
                    <div class="card-header">
                        <div class="mb-2">
                            <%- include('includes/flash') %>
                            <h3 class="text-center"><%= entry.title %></h3>
                          </div>

                          <div class="col-md-6 offset-md-3">
                              <hr>
                          </div>

                          <div class="mb-2 text-center">
                            <h5><i class="align-middle mr-5 fas fa-fw fa-map-marker-alt text-primary"></i><%= entry.place %></h5>
                          </div>
                
                          <div class="mb-2">
                              <h5 class="text-center text-muted">on <%= new Date(entry.date).toLocaleString('default', { month: 'long' }) %> <%= new Date(entry.date).getDate() %>, <%= new Date(entry.date).getFullYear() %> | by <a href="/journal/<%= entry.author.username %>"><%= entry.author.username %></a></h5>
                          </div>

                        <div class="card-body"> 

                          <div class="body-content">
                            <div class="text-center mb-1">
                              <div id="singlemap" style="height: 300px;"></div>
                              <!--<img src="https://api.mapbox.com/styles/v1/mapbox/light-v10/static/pin-s+3C73AA(<%=entry.GeoJSONcoordinates.coordinates%>)/<%=entry.GeoJSONcoordinates.coordinates%>,6/300x300?access_token=pk.eyJ1IjoiY25oMTE4NyIsImEiOiJja28wZTZpNGowY3RoMnBvaTgxZ2M5c3ljIn0.t3_T3EN00e5w7D0et4hf-w">-->
                            </div>
                            <div class="mb-4 text-center">
                              <small>Longitude: <%= entry.GeoJSONcoordinates.coordinates[0]%>, Latitude: <%= entry.GeoJSONcoordinates.coordinates[1]%></small>
                            </div>


                            <div class="mb-5">
                              <%- filterUserHTML(entry.body) %>
                            </div>

                            <% if (entry.hasPhoto) { %>

                            <div class="mb-5">
                              <img src="https://f002.backblazeb2.com/file/heimursaga-entry-photos/<%= entry._id %>" class="img-fluid" alt="entry image">
                            </div>

                            <% } %>

                          </div>

                          <% if (user) { %>
                      
                            <div class="col-md-6 offset-md-3">
                              <div class="row">
                                <div class="col-3 offset-1 overflow-hidden" id="single-entry-likes">
  
                                  <iframe src="single-entry-likes/<%=entry._id%>" id="single-entry-likes" height="23"></iframe>
  
                                </div>
  
                                <div class="col-4 offset-3 overflow-hidden" id="single-entry-flags">
  
                                  <iframe src="single-entry-flags/<%=entry._id%>" id="single-entry-flags" height="21"></iframe>
  
                                </div>
                              </div>
                            </div>

                          <% } %>


                          <div class="col-md-6 offset-md-3 mb-4">
                            <hr>
                          </div>

                          <div>
                            <p class="text-muted small mb-4 text-center">
                            <a href="/journal/<%= entry.author.username %>"><img class="avatar img-fluid rounded-circle me-1" src="<%= entry.author.avatar %>"></a>
                            Posted on <%= entry.createdDate.getMonth() + 1 %>/<%= entry.createdDate.getDate() %>/<%= entry.createdDate.getFullYear() %></p>
                          </div> 

                          <div class="row justify-content-between">
                            <% if (entry.isVisitorOwner) { %>
                                <span class="pe-2">
                                  <a href="/entry/<%= entry._id %>/edit" class="text-primary mr-2" data-toggle="tooltip" data-placement="top" title="Edit"><i class="fas fa-edit"></i></a>
                                  <form onsubmit="return confirm('Are you sure you want to delete this entry? This action is irreversible.');" class="delete-post-form d-inline" action="/entry/<%= entry._id %>/delete" method="POST">
                                    
                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

                                    <button class="text-danger" data-toggle="tooltip" data-placement="top" title="Delete"><i class="fas fa-trash"></i></button>
                                  </form>
                                </span>
                              <% } %>

                          </div>

                          <!--<% if (user && !entry.isVisitorOwner) { %>
                          <div class="col-xl-12 offset-md-2 text-center overflow-hidden" id="single-entry-flags">
                                
                            <iframe src="single-entry-flags/<%=entry._id%>" id="single-entry-flags" height="21"></iframe>

                          </div>
                          <% } %>-->
                        </div> 
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>




function convertToPlain(html){
        var tempDivElement = document.createElement('entrymarkers');
        tempDivElement.innerHTML = html;
        return tempDivElement.textContent || tempDivElement.innerText || '';
    }

    var htmlString= '<entrymarkers><%= entrymarker %></entrymarkers>'

    var marker = (convertToPlain(htmlString))

var singlemarker = JSON.parse(marker)

mapboxgl.accessToken = 'pk.eyJ1IjoiY25oMTE4NyIsImEiOiJja28wZTZpNGowY3RoMnBvaTgxZ2M5c3ljIn0.t3_T3EN00e5w7D0et4hf-w';

const singlemap = new mapboxgl.Map({
    container: 'singlemap',
    style: 'mapbox://styles/cnh1187/ckppoum2i01vk17mzb71uh331',
    center: singlemarker.properties.coordinates,
    zoom: 1,
    attributionControl: false,
    dragRotate: false,
    touchPitch: false,
    doubleClickZoom: false,
    dragPan: false,
    scrollZoom: false,
    touchZoomRotate: false,
    touchPan: false,
    maxZoom: 22
});

singlemap.addControl(new mapboxgl.NavigationControl())

singlemap.on('load', function () {
  var marker = new mapboxgl.Marker({
				color: '#ac6d46',
				draggable: false,
				})
				.setLngLat(singlemarker.properties.coordinates)
				.addTo(singlemap);

    singlemap.flyTo({
          center: singlemarker.properties.coordinates,
          zoom: 9,
          speed: 0.4,
          curve: 1,
          essential: true,
          })
     
    })


</script>
			
<%- include('includes/footer') %>
